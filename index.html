<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Inteligente de Múltiples Registros</title>
    <!-- Librerías de PDF, Firma y ZIP -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> <!-- Para comprimir en ZIP -->

    <style>
        body { font-family: sans-serif; background-color: #e9ecef; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #343a40; }
        .step { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #dee2e6; }
        input[type="file"], input[type="text"], button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ced4da; box-sizing: border-box; font-size: 16px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #c0c0c0; cursor: not-allowed; }
        #file-list { margin-top: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px;}
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0; }
        .file-item:last-child { border-bottom: none; }
        .file-status { font-weight: bold; padding: 3px 8px; border-radius: 12px; font-size: 12px; }
        .status-pending { background-color: #e2e3e5; color: #383d41; }
        .status-found { background-color: #d1ecf1; color: #0c5460; }
        .status-signed { background-color: #d4edda; color: #155724; }
        .status-not-found { background-color: #f8d7da; color: #721c24; }
        #status { text-align: center; font-weight: bold; margin-top: 20px; padding: 10px; border-radius: 5px; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-info { background-color: #cce5ff; color: #004085; }

        /* Modal de firma a pantalla completa */
        #signature-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 10px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        #signature-pad { border: 2px dashed #007bff; border-radius: 5px; touch-action: none; /* Evita scroll en móvil al firmar */ }
        .modal-content h3 { margin-top: 0; }
        .modal-controls { display: flex; justify-content: center; width: 100%; margin-top: 15px; }
        .modal-controls button { width: auto; padding: 10px 20px; margin: 0 10px; }

        /* Estilos para el lienzo de firma horizontal en móviles */
        @media (max-width: 768px) {
            .modal-content { width: 95vw; }
            #signature-pad { width: 90vw; height: 40vh; /* Lienzo horizontal */ }
        }
        @media (min-width: 769px) {
            #signature-pad { width: 500px; height: 250px; /* Lienzo normal en desktop */ }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firma Inteligente de Múltiples Registros</h1>
        <p style="text-align:center;">Cargue uno o varios documentos. La herramienta encontrará su cédula y colocará su firma en el lugar correcto automáticamente.</p>

        <div class="step">
            <h2>Paso 1: Cargar Documento(s) PDF</h2>
            <input type="file" id="file-input" accept=".pdf" multiple>
            <div id="file-list"></div>
        </div>

        <div class="step">
            <h2>Paso 2: Identifíquese para Firmar</h2>
            <p>Ingrese su número de cédula. Su firma se aplicará en todos los documentos cargados donde se encuentre.</p>
            <input type="text" id="cedula-input" placeholder="Escriba su cédula sin puntos" disabled>
            <button id="sign-btn" disabled>Buscar y Abrir Panel de Firma</button>
        </div>

        <div class="step">
            <h2>Paso 3: Descargar</h2>
            <button id="download-btn" disabled>Descargar Todo como ZIP</button>
            <button id="whatsapp-btn" disabled>Compartir en WhatsApp</button>
        </div>

        <div id="status"></div>
    </div>

    <!-- Modal para el panel de firma -->
    <div id="signature-modal">
        <div class="modal-content">
            <h3 id="signature-user-name">Dibuja tu firma en el recuadro</h3>
            <canvas id="signature-pad"></canvas>
            <div class="modal-controls">
                <button id="clear-signature">Limpiar</button>
                <button id="save-signature">Aceptar y Firmar</button>
            </div>
        </div>
    </div>

<script>
    // --- ¡IMPORTANTE! CONFIGURACIÓN DE LA FIRMA ---
    const SIGNATURE_COLUMN_X = 420; // Posición HORIZONTAL (eje X) donde comenzarán TODAS las firmas.
    const SIGNATURE_Y_OFFSET = -4;  // Ajuste VERTICAL fino. Un valor negativo baja la firma, positivo la sube.
    const SIGNATURE_WIDTH = 97;     // Ancho de la imagen de la firma en el PDF.
    const SIGNATURE_HEIGHT = 20;    // Alto de la imagen de la firma en el PDF.
    // ------------------------------------------------

    // Referencias a librerías
    const { PDFDocument } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

    // Elementos del DOM
    const fileInput = document.getElementById('file-input');
    const fileListDiv = document.getElementById('file-list');
    const cedulaInput = document.getElementById('cedula-input');
    const signBtn = document.getElementById('sign-btn');
    const downloadBtn = document.getElementById('download-btn');
    const whatsappBtn = document.getElementById('whatsapp-btn');
    const statusDiv = document.getElementById('status');
    const signatureModal = document.getElementById('signature-modal');
    const signaturePadCanvas = document.getElementById('signature-pad');
    const signatureUserName = document.getElementById('signature-user-name');
    const saveSignatureBtn = document.getElementById('save-signature');
    const clearSignatureBtn = document.getElementById('clear-signature');

    // Variables de estado
    let loadedFiles = []; // Almacenará objetos de cada archivo cargado
    let signaturePad; // Se inicializará al abrir el modal

    // --- LÓGICA DE MANEJO DE ARCHIVOS ---

    fileInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files.length === 0) return;
        
        resetUI();
        updateStatus(`Cargando y analizando ${files.length} archivo(s)...`, 'info');

        const filePromises = Array.from(files).map(async (file) => {
            if (file.type !== 'application/pdf') {
                console.warn(`Archivo omitido por no ser PDF: ${file.name}`);
                return null;
            }
            const originalBytes = new Uint8Array(await file.arrayBuffer());
            const textContent = await extractTextFromPdf(originalBytes);
            return {
                name: file.name,
                originalBytes,
                modifiedBytes: originalBytes, // Inicia igual al original
                textContent,
                status: 'pending', // 'pending', 'found', 'not-found', 'signed'
                signatureLocation: null
            };
        });

        loadedFiles = (await Promise.all(filePromises)).filter(f => f !== null); // Filtra los no-PDF

        if (loadedFiles.length > 0) {
            cedulaInput.disabled = false;
            signBtn.disabled = false;
            updateStatus(`Análisis completado. Ingrese su cédula para buscar y firmar.`, 'success');
        } else {
            updateStatus('No se cargaron archivos PDF válidos.', 'error');
        }
        renderFileList();
    });

    // --- LÓGICA DE FIRMA ---

    signBtn.addEventListener('click', () => {
        const cedula = cedulaInput.value.trim().replace(/\.|,/g, '');
        if (!cedula) {
            alert('Por favor, ingrese su número de cédula.');
            return;
        }

        let foundCount = 0;
        loadedFiles.forEach(file => {
            const foundLine = file.textContent.find(line => line.fullText.replace(/\s/g, '').includes(cedula));
            if (foundLine) {
                file.signatureLocation = {
                    pageIndex: foundLine.pageIndex,
                    x: SIGNATURE_COLUMN_X,
                    y: foundLine.y + SIGNATURE_Y_OFFSET
                };
                file.status = 'found';
                foundCount++;
            } else {
                file.signatureLocation = null;
                file.status = file.status === 'signed' ? 'signed' : 'not-found';
            }
        });

        renderFileList();

        if (foundCount > 0) {
            updateStatus(`Cédula encontrada en ${foundCount} documento(s). Listo para firmar.`, 'info');
            signatureUserName.textContent = `Confirma tu firma para C.I. ${cedula}`;
            openSignatureModal();
        } else {
            updateStatus(`Cédula "${cedula}" no encontrada en ningún documento pendiente. Verifique el número.`, 'error');
        }
    });

    function openSignatureModal() {
        signatureModal.style.display = 'flex';
        // Ajustar el tamaño del canvas al ser visible y crear la instancia de SignaturePad
        setTimeout(() => {
            const canvas = document.getElementById('signature-pad');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            if (signaturePad) {
                signaturePad.clear();
            } else {
                signaturePad = new SignaturePad(canvas);
            }
        }, 10);
    }
    
    clearSignatureBtn.addEventListener('click', () => signaturePad.clear());

    saveSignatureBtn.addEventListener('click', async () => {
        if (signaturePad.isEmpty()) {
            alert("Por favor, dibuje su firma.");
            return;
        }
        
        signatureModal.style.display = 'none';
        updateStatus('Procesando firmas, por favor espere...', 'info');

        try {
            // Obtener la firma y rotarla si es necesario
            const signatureImage = await getProcessedSignatureImage();
            
            // Aplicar la firma a todos los archivos marcados
            const signPromises = loadedFiles
                .filter(file => file.status === 'found')
                .map(file => embedSignature(signatureImage, file));

            await Promise.all(signPromises);

            downloadBtn.disabled = false;
            whatsappBtn.disabled = false;
            cedulaInput.value = '';
            updateStatus(`¡Proceso completado! Documentos firmados con éxito.`, 'success');
            renderFileList();

        } catch (err) {
            updateStatus(`Error al procesar las firmas: ${err.message}`, 'error');
            console.error(err);
        }
    });

    async function getProcessedSignatureImage() {
        const isMobileLayout = window.innerWidth <= 768;
        const originalDataUrl = signaturePad.toDataURL('image/png');

        // Si NO es móvil (lienzo normal) o si la firma está vacía, devolverla tal cual.
        if (!isMobileLayout || signaturePad.isEmpty()) {
            return originalDataUrl;
        }

        // Si es móvil, el lienzo es horizontal, así que rotamos la imagen para que sea vertical.
        return new Promise((resolve, reject) => {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            const img = new Image();

            img.onload = () => {
                // El nuevo canvas tendrá las dimensiones intercambiadas
                tempCanvas.width = img.height;
                tempCanvas.height = img.width;

                // Rotar el contexto 90 grados y dibujar la imagen
                tempCtx.translate(tempCanvas.width, 0);
                tempCtx.rotate(90 * Math.PI / 180);
                tempCtx.drawImage(img, 0, 0);

                resolve(tempCanvas.toDataURL('image/png'));
            };
            img.onerror = reject;
            img.src = originalDataUrl;
        });
    }


    async function embedSignature(signatureImage, file) {
        const pdfDoc = await PDFDocument.load(file.modifiedBytes);
        const pngImageBytes = await fetch(signatureImage).then(res => res.arrayBuffer());
        const pngImage = await pdfDoc.embedPng(pngImageBytes);
        
        const page = pdfDoc.getPage(file.signatureLocation.pageIndex);

        page.drawImage(pngImage, {
            x: file.signatureLocation.x,
            y: file.signatureLocation.y,
            width: SIGNATURE_WIDTH,
            height: SIGNATURE_HEIGHT,
        });

        file.modifiedBytes = await pdfDoc.save();
        file.status = 'signed';
        file.signatureLocation = null; // Limpiar para la siguiente firma
    }

    // --- LÓGICA DE DESCARGA Y UI ---

    downloadBtn.addEventListener('click', async () => {
        const signedFiles = loadedFiles.filter(f => f.status === 'signed');
        if (signedFiles.length === 0) {
            alert("No hay documentos firmados para descargar.");
            return;
        }

        updateStatus('Preparando archivo ZIP para la descarga...', 'info');

        const zip = new JSZip();
        signedFiles.forEach(file => {
            const signedName = file.name.replace(/\.pdf$/i, '-firmado.pdf');
            zip.file(signedName, file.modifiedBytes, { binary: true });
        });

        const zipBlob = await zip.generateAsync({ type: "blob" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = "documentos-firmados.zip";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        updateStatus('¡ZIP descargado!', 'success');
    });
    
    whatsappBtn.addEventListener('click', () => {
        alert("Para compartir en WhatsApp:\n\n1. Descargue el archivo ZIP con el botón de al lado.\n2. Descomprima el archivo en su dispositivo.\n3. Abra WhatsApp y adjunte los PDFs firmados individualmente.");
    });

    function renderFileList() {
        fileListDiv.innerHTML = '';
        if (loadedFiles.length === 0) {
            fileListDiv.innerHTML = '<p style="text-align:center; color:#888;">Ningún archivo cargado.</p>';
            return;
        }
        loadedFiles.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileName = document.createElement('span');
            fileName.textContent = file.name.length > 40 ? file.name.substring(0, 37) + '...' : file.name;
            
            const fileStatus = document.createElement('span');
            fileStatus.className = 'file-status';
            
            switch(file.status) {
                case 'pending':
                    fileStatus.textContent = 'Pendiente';
                    fileStatus.classList.add('status-pending');
                    break;
                case 'found':
                    fileStatus.textContent = 'Cédula encontrada';
                    fileStatus.classList.add('status-found');
                    break;
                case 'not-found':
                    fileStatus.textContent = 'No encontrado';
                    fileStatus.classList.add('status-not-found');
                    break;
                case 'signed':
                    fileStatus.textContent = 'Firmado';
                    fileStatus.classList.add('status-signed');
                    break;
            }
            
            fileItem.appendChild(fileName);
            fileItem.appendChild(fileStatus);
            fileListDiv.appendChild(fileItem);
        });
    }

    async function extractTextFromPdf(pdfBytes) {
        const textContent = [];
        const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

        for (let i = 0; i < pdfJsDoc.numPages; i++) {
            const page = await pdfJsDoc.getPage(i + 1);
            const pageTextContent = await page.getTextContent();
            
            const lines = {};
            pageTextContent.items.forEach(item => {
                const yKey = Math.round(item.transform[5]);
                if (!lines[yKey]) lines[yKey] = [];
                lines[yKey].push({ text: item.str, x: item.transform[4] });
            });
            
            for (const yKey in lines) {
                const sortedItems = lines[yKey].sort((a, b) => a.x - b.x);
                const fullText = sortedItems.map(item => item.text).join(' ');
                textContent.push({ fullText, y: parseFloat(yKey), pageIndex: i });
            }
        }
        return textContent;
    }
    
    function updateStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `status-${type}`;
    }

    function resetUI() {
        loadedFiles = [];
        renderFileList();
        cedulaInput.disabled = true;
        signBtn.disabled = true;
        downloadBtn.disabled = true;
        whatsappBtn.disabled = true;
        cedulaInput.value = '';
        statusDiv.innerHTML = '';
        statusDiv.className = '';
    }

</script>
</body>
</html>
