<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Inteligente de Registro de Formación</title>
    <!-- Librerías de PDF y Firma -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <!-- PDF.js para renderizar y extraer texto -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <style>
        body { font-family: sans-serif; background-color: #e9ecef; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #343a40; }
        .step { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #dee2e6; }
        input[type="file"], input[type="text"], button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ced4da; box-sizing: border-box; font-size: 16px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #c0c0c0; cursor: not-allowed; }
        #pdf-viewer { border: 1px solid #ccc; margin-top: 20px; max-height: 80vh; overflow-y: auto; }
        #pdf-viewer canvas { display: block; margin: 10px auto; box-shadow: 0 0 8px rgba(0,0,0,0.2); width: 100%; height: auto; }
        #status { text-align: center; font-weight: bold; margin-top: 20px; padding: 10px; border-radius: 5px; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-info { background-color: #cce5ff; color: #004085; }

        /* --- ESTILOS MEJORADOS PARA EL MODAL DE FIRMA --- */
        #signature-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.8);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-width: 95vw;
            max-height: 95vh;
        }
        #signature-canvas-container {
            flex-grow: 1; /* Ocupa el espacio disponible */
            position: relative;
            border: 2px dashed #007bff;
            border-radius: 5px;
            touch-action: none; /* Evita scroll en móvil al firmar */
        }
        #signature-pad {
            width: 100%;
            height: 100%;
            display: block;
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            flex-shrink: 0; /* Evita que el título se encoja */
        }
        .modal-controls {
            margin-top: 15px;
            flex-shrink: 0; /* Evita que los controles se encojan */
        }
        .modal-controls button {
            width: auto;
            padding: 10px 20px;
            margin: 0 10px;
        }

        /* VISTA HORIZONTAL PARA MÓVILES (PANTALLA COMPLETA) */
        @media (max-width: 768px) and (orientation: landscape) {
             #signature-modal {
                padding: 0;
             }
            .modal-content {
                flex-direction: row; /* Canvas a la izquierda, botones a la derecha */
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                padding: 15px;
                gap: 15px;
            }
             .modal-content h3 {
                display: none; /* Ocultamos el título para dar más espacio */
            }
            .modal-controls {
                flex-direction: column; /* Botones en columna */
                justify-content: center;
                margin-top: 0;
                width: 120px; /* Ancho fijo para la columna de botones */
                flex-shrink: 0;
            }
            .modal-controls button {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firma Inteligente de Registro de Formación</h1>
        <p style="text-align:center;">Esta herramienta encontrará tu cédula en el PDF y colocará tu firma en el lugar correcto automáticamente.</p>

        <div class="step">
            <h2>Paso 1: Cargar el Documento PDF</h2>
            <input type="file" id="file-input" accept=".pdf">
        </div>

        <div class="step">
            <h2>Paso 2: Identifíquese para Firmar</h2>
            <p>Ingrese su número de cédula y presione "Buscar y Abrir Panel de Firma".</p>
            <input type="text" id="cedula-input" placeholder="Escriba su cédula sin puntos" disabled>
            <button id="sign-btn" disabled>Buscar y Abrir Panel de Firma</button>
        </div>

        <div class="step">
            <h2>Paso 3: Descargar y Compartir</h2>
            <button id="download-btn" disabled>Descargar PDF Firmado</button>
            <button id="whatsapp-btn" disabled>Compartir en WhatsApp</button>
        </div>

        <div id="status"></div>
        <div id="pdf-viewer"></div>
    </div>

    <!-- Modal para el panel de firma -->
    <div id="signature-modal">
        <div class="modal-content">
            <h3 id="signature-user-name">Dibuja tu firma en el recuadro</h3>
            <div id="signature-canvas-container">
                 <canvas id="signature-pad"></canvas>
            </div>
            <div class="modal-controls">
                <button id="clear-signature">Limpiar</button>
                <button id="save-signature">Aceptar y Guardar</button>
            </div>
        </div>
    </div>

<script>
    // --- ¡IMPORTANTE! CONFIGURACIÓN DE LA FIRMA ---
    const SIGNATURE_COLUMN_X = 420;
    const SIGNATURE_Y_OFFSET = -4;
    const SIGNATURE_WIDTH = 97;
    const SIGNATURE_HEIGHT = 20;
    // ------------------------------------------------

    // Referencias a librerías
    const { PDFDocument } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

    // Elementos del DOM
    const fileInput = document.getElementById('file-input');
    const cedulaInput = document.getElementById('cedula-input');
    const signBtn = document.getElementById('sign-btn');
    const downloadBtn = document.getElementById('download-btn');
    const whatsappBtn = document.getElementById('whatsapp-btn');
    const pdfViewer = document.getElementById('pdf-viewer');
    const statusDiv = document.getElementById('status');
    const signatureModal = document.getElementById('signature-modal');
    const signaturePadCanvas = document.getElementById('signature-pad');
    const signatureUserName = document.getElementById('signature-user-name');
    const saveSignatureBtn = document.getElementById('save-signature');
    const clearSignatureBtn = document.getElementById('clear-signature');
    const signatureCanvasContainer = document.getElementById('signature-canvas-container');

    // Variables de estado
    let pdfDoc = null;
    let pdfBytes = null;
    let pdfTextContent = [];
    let currentUser = null;
    let signaturePad = new SignaturePad(signaturePadCanvas);

    // --- LÓGICA PRINCIPAL ---

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || file.type !== 'application/pdf') {
            updateStatus('Por favor, selecciona un archivo PDF válido.', 'error');
            return;
        }
        resetUI();
        updateStatus('Cargando y analizando el PDF...', 'info');
        try {
            const arrayBuffer = await file.arrayBuffer();
            pdfBytes = new Uint8Array(arrayBuffer);
            pdfDoc = await PDFDocument.load(pdfBytes);
            await renderPdf();
            await extractTextFromPdf();
            cedulaInput.disabled = false;
            signBtn.disabled = false;
            updateStatus('PDF cargado y analizado. Ingrese su cédula para firmar.', 'success');
        } catch (err) {
            updateStatus(`Error al cargar el PDF: ${err.message}`, 'error');
            console.error(err);
        }
    });

    signBtn.addEventListener('click', () => {
        const cedula = cedulaInput.value.trim().replace(/\.|,/g, '');
        if (!cedula) {
            alert('Por favor, ingrese su número de cédula.');
            return;
        }

        const foundLine = pdfTextContent.find(line => line.fullText.replace(/\s/g, '').includes(cedula));
        
        if (foundLine) {
            currentUser = {
                cedula: cedula,
                nombre: foundLine.fullText,
                x: SIGNATURE_COLUMN_X,
                y: foundLine.y + SIGNATURE_Y_OFFSET,
                pageIndex: foundLine.pageIndex
            };
            signatureUserName.textContent = `Confirma tu firma`;
            signatureModal.style.display = 'flex';
            setTimeout(setupSignatureCanvas, 50); // Pequeño delay para asegurar que el modal es visible
        } else {
            updateStatus(`Cédula "${cedula}" no encontrada en el documento. Por favor, verifique.`, 'error');
        }
    });

    clearSignatureBtn.addEventListener('click', () => {
        // Limpiamos y redibujamos la línea guía
        signaturePad.clear();
        drawGuideline();
    });

    saveSignatureBtn.addEventListener('click', async () => {
        if (signaturePad.isEmpty()) {
            alert("Por favor, dibuje su firma.");
            return;
        }
        const signatureImage = signaturePad.toDataURL('image/png');
        signatureModal.style.display = 'none';
        updateStatus('Incrustando firma en el documento...', 'info');
        await embedSignature(signatureImage, currentUser);
    });

    async function embedSignature(signatureImage, user) {
        try {
            pdfDoc = await PDFDocument.load(pdfBytes);
            const pngImageBytes = await fetch(signatureImage).then(res => res.arrayBuffer());
            const pngImage = await pdfDoc.embedPng(pngImageBytes);
            const page = pdfDoc.getPage(user.pageIndex || 0);
            page.drawImage(pngImage, {
                x: user.x,
                y: user.y,
                width: SIGNATURE_WIDTH,
                height: SIGNATURE_HEIGHT,
            });
            pdfBytes = await pdfDoc.save();
            await renderPdf();
            downloadBtn.disabled = false;
            whatsappBtn.disabled = false;
            cedulaInput.value = '';
            updateStatus(`¡Firma para cédula ${user.cedula} añadida con éxito! Ya puede firmar otro o descargar.`, 'success');
        } catch (err) {
            updateStatus(`Error al incrustar la firma: ${err.message}`, 'error');
            console.error(err);
        }
    }

    downloadBtn.addEventListener('click', () => {
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const originalFileName = fileInput.files[0].name.replace(/\.pdf$/i, '');
        link.download = `${originalFileName}-firmado.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    
    whatsappBtn.addEventListener('click', () => {
        alert("Para compartir en WhatsApp:\n\n1. Primero, descargue el PDF firmado con el botón de al lado.\n2. Luego, abra WhatsApp y adjunte el archivo descargado.");
    });

    // --- FUNCIONES AUXILIARES Y DE FIRMA MEJORADAS ---

    function setupSignatureCanvas() {
        // Redimensionar el canvas
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = signatureCanvasContainer.getBoundingClientRect();
        signaturePadCanvas.width = rect.width * ratio;
        signaturePadCanvas.height = rect.height * ratio;
        signaturePadCanvas.getContext("2d").scale(ratio, ratio);
        
        // Limpiar cualquier firma anterior y dibujar la guía
        signaturePad.clear();
        drawGuideline();
    }

    function drawGuideline() {
        const ctx = signaturePadCanvas.getContext('2d');
        const width = signaturePadCanvas.clientWidth;
        const height = signaturePadCanvas.clientHeight;
        
        // Estilo de la línea guía
        ctx.strokeStyle = '#c0c0c0';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 10]); // Línea punteada
        
        // Dibujar la línea en el centro vertical
        const y_center = height / 2;
        ctx.beginPath();
        ctx.moveTo(10, y_center);
        ctx.lineTo(width - 10, y_center);
        ctx.stroke();

        // Añadir texto de ayuda
        ctx.setLineDash([]); // Reset a línea sólida
        ctx.font = "14px Arial";
        ctx.fillStyle = "#c0c0c0";
        ctx.textAlign = "center";
        ctx.fillText("Firme sobre la línea", width / 2, y_center - 10);
    }

    // Escuchar cambios de tamaño/orientación para redibujar el canvas si está abierto
    window.addEventListener('resize', () => {
        if (signatureModal.style.display === 'flex') {
            setupSignatureCanvas();
        }
    });

    async function renderPdf() {
        pdfViewer.innerHTML = '';
        const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
        for (let i = 0; i < pdfJsDoc.numPages; i++) {
            const page = await pdfJsDoc.getPage(i + 1);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            pdfViewer.appendChild(canvas);
        }
    }

    async function extractTextFromPdf() {
        pdfTextContent = [];
        const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
        for (let i = 0; i < pdfJsDoc.numPages; i++) {
            const page = await pdfJsDoc.getPage(i + 1);
            const textContent = await page.getTextContent();
            const lines = {};
            textContent.items.forEach(item => {
                const y = item.transform[5];
                const x = item.transform[4];
                const yKey = Math.round(y);
                if (!lines[yKey]) lines[yKey] = [];
                lines[yKey].push({ text: item.str, x: x });
            });
            for (const yKey in lines) {
                const sortedItems = lines[yKey].sort((a, b) => a.x - b.x);
                const fullText = sortedItems.map(item => item.text).join(' ');
                pdfTextContent.push({
                    fullText: fullText,
                    y: parseFloat(yKey),
                    pageIndex: i
                });
            }
        }
        console.log("Contenido de texto extraído del PDF:", pdfTextContent);
    }
    
    function updateStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `status status-${type}`;
    }

    function resetUI() {
        cedulaInput.disabled = true;
        signBtn.disabled = true;
        downloadBtn.disabled = true;
        whatsappBtn.disabled = true;
        cedulaInput.value = '';
        pdfViewer.innerHTML = '';
        statusDiv.innerHTML = '';
        statusDiv.className = '';
    }

</script>
</body>
</html>
