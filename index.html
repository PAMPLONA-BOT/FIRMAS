<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Inteligente de Registro</title>
    <!-- Librerías de PDF y Firma -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    
    <!-- Iconos (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ESTILOS PROFESIONALES Y MOBILE-FIRST --- */
        
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            /* <!-- MODIFICADO: Añadido color para hover del botón secundario --> */
            --secondary-hover: #5a6268;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --dark-text: #343a40;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }

        .header {
            background-color: var(--white);
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5em;
            color: var(--primary-color);
            margin: 0;
        }

        .main-container {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--white);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary-color);
        }
        
        .card h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-text);
        }
        
        .card p {
            font-size: 0.9em;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        /* --- Estilos de Controles --- */
        
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        button, .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }

        /* <!-- MODIFICADO: Estilo genérico para compartir en lugar de WhatsApp --> */
        .btn-share { background-color: var(--secondary-color); color: white; }
        .btn-share:hover:not(:disabled) { background-color: var(--secondary-hover); }
        
        button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Ocultar input de archivo real */
        #file-input { display: none; }

        /* --- PDF Viewer y Status --- */
        
        #pdf-viewer {
            border: 1px dashed var(--border-color);
            margin-top: 20px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 8px;
            padding: 10px;
        }
        #pdf-viewer canvas {
            display: block;
            margin: 10px auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        #status {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none; /* Oculto por defecto, se muestra con JS */
        }
        #status.show { display: block; }
        .status-success { background-color: #d4edda; color: #155724; border-left: 5px solid var(--success-color); }
        .status-error { background-color: #f8d7da; color: #721c24; border-left: 5px solid var(--danger-color); }
        .status-info { background-color: #cce5ff; color: #004085; border-left: 5px solid var(--primary-color); }

        /* --- Modal de Firma Rediseñado --- */
        
        #signature-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        .modal-content {
            background-color: var(--white);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slide-in 0.3s ease-out;
        }

        @keyframes slide-in {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #signature-pad {
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            width: 100%;
            height: auto;
            aspect-ratio: 2 / 1;
            cursor: crosshair;
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .modal-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .modal-controls button {
            width: 100%;
        }
        #clear-signature {
            background-color: transparent;
            color: var(--secondary-color);
            border: 1px solid var(--border-color);
        }
        #clear-signature:hover {
            background-color: var(--light-bg);
        }
        #save-signature {
            background-color: var(--success-color);
            color: white;
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>Firma Inteligente de Documentos</h1>
    </header>

    <main class="main-container">
        
        <div class="card">
            <h2><i class="fa-solid fa-file-arrow-up"></i>Paso 1: Cargar Documento</h2>
            <p>Seleccione el registro de formación en formato PDF para comenzar.</p>
            <input type="file" id="file-input" accept=".pdf">
            <label for="file-input" class="btn btn-primary">
                <i class="fa-solid fa-folder-open"></i>
                Seleccionar PDF
            </label>
        </div>

        <div class="card">
            <h2><i class="fa-solid fa-pen-fancy"></i>Paso 2: Identifíquese</h2>
            <p>Ingrese su <b>cédula</b> para firmar como participante, o escriba <b>"firma"</b> si es el instructor.</p>
            <div class="input-group">
                <input type="text" id="cedula-input" placeholder="Escriba su cédula o la palabra 'firma'" disabled>
                <button id="sign-btn" class="btn-primary" disabled>
                    <i class="fa-solid fa-magnifying-glass"></i>
                    Buscar y Firmar
                </button>
            </div>
        </div>

        <div class="card">
            <h2><i class="fa-solid fa-circle-down"></i>Paso 3: Descargar y Compartir</h2>
            <p>Una vez firmado, puede descargar el documento o compartirlo directamente.</p>
            <div class="input-group">
                <button id="download-btn" class="btn-primary" disabled>
                    <i class="fa-solid fa-download"></i>
                    Descargar PDF Firmado
                </button>
                <!-- MODIFICADO: El botón ahora es genérico para compartir -->
                <button id="share-btn" class="btn-share" disabled>
                    <i class="fa-solid fa-share-nodes"></i>
                    Compartir
                </button>
            </div>
        </div>

        <div id="status"></div>
        <div id="pdf-viewer"></div>
    </main>

    <!-- Modal para el panel de firma -->
    <div id="signature-modal">
        <div class="modal-content">
            <h3 id="signature-user-name">Dibuja tu firma en el recuadro</h3>
            <canvas id="signature-pad"></canvas>
            <div class="modal-controls">
                <button id="clear-signature">
                    <i class="fa-solid fa-eraser"></i> Limpiar
                </button>
                <button id="save-signature">
                    <i class="fa-solid fa-check"></i> Aceptar y Guardar
                </button>
            </div>
        </div>
    </div>

<script>
    // --- LÓGICA DE JAVASCRIPT COMPLETA Y CORREGIDA ---

    // --- ¡IMPORTANTE! CONFIGURACIÓN DE LAS FIRMAS ---
    const PARTICIPANT_SIGNATURE_COLUMN_X = 420;
    const PARTICIPANT_SIGNATURE_Y_OFFSET = -4;
    const PARTICIPANT_SIGNATURE_WIDTH = 97;
    const PARTICIPANT_SIGNATURE_HEIGHT = 20;
    const INSTRUCTOR_SIGNATURE_TEXT = 'FIRMA DEL INSTRUCTOR';
    const INSTRUCTOR_SIGNATURE_X_OFFSET = -15;
    const INSTRUCTOR_SIGNATURE_Y_OFFSET = 6;
    const INSTRUCTOR_SIGNATURE_WIDTH = 120;
    const INSTRUCTOR_SIGNATURE_HEIGHT = 15;
    
    // Referencias a librerías
    const { PDFDocument } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

    // Elementos del DOM
    const fileInput = document.getElementById('file-input');
    const cedulaInput = document.getElementById('cedula-input');
    const signBtn = document.getElementById('sign-btn');
    const downloadBtn = document.getElementById('download-btn');
    // <!-- MODIFICADO: Referencia al nuevo botón de compartir -->
    const shareBtn = document.getElementById('share-btn');
    const pdfViewer = document.getElementById('pdf-viewer');
    const statusDiv = document.getElementById('status');
    const signatureModal = document.getElementById('signature-modal');
    const signaturePadCanvas = document.getElementById('signature-pad');
    const signatureUserName = document.getElementById('signature-user-name');
    const saveSignatureBtn = document.getElementById('save-signature');
    const clearSignatureBtn = document.getElementById('clear-signature');

    // Variables de estado
    let pdfDoc = null;
    let pdfBytes = null;
    let pdfTextContent = [];
    let locationsToSign = [];

    // Se inicializa SIN fondo para que la firma sea transparente
    let signaturePad = new SignaturePad(signaturePadCanvas);

    // Función para ajustar el tamaño del canvas de la firma (importante para móviles)
    function resizeCanvas() {
        const ratio =  Math.max(window.devicePixelRatio || 1, 1);
        const canvas = signaturePad.canvas;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear(); 
    }
    
    // --- LÓGICA PRINCIPAL ---
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || file.type !== 'application/pdf') {
            updateStatus('Por favor, selecciona un archivo PDF válido.', 'error');
            return;
        }
        
        resetUI();
        updateStatus('Cargando y analizando el PDF...', 'info');

        try {
            const arrayBuffer = await file.arrayBuffer();
            pdfBytes = new Uint8Array(arrayBuffer);
            pdfDoc = await PDFDocument.load(pdfBytes);
            
            await renderPdf();
            await extractTextFromPdf();

            cedulaInput.disabled = false;
            signBtn.disabled = false;
            updateStatus('PDF cargado. Ingrese su cédula o la palabra "firma" para continuar.', 'success');
        } catch (err) {
            updateStatus(`Error al cargar el PDF: ${err.message}`, 'error');
            console.error(err);
        }
    });

    signBtn.addEventListener('click', () => {
        const userInput = cedulaInput.value.trim().toLowerCase();
        if (!userInput) {
            alert('Por favor, ingrese su cédula o la palabra "firma".');
            return;
        }

        let foundLines = [];
        let isInstructorSign = false;

        if (userInput === 'firma') {
            isInstructorSign = true;
            foundLines = pdfTextContent.filter(line => 
                line.fullText.toUpperCase().includes(INSTRUCTOR_SIGNATURE_TEXT)
            );
        } else {
            const cedula = userInput.replace(/\.|,/g, '');
            foundLines = pdfTextContent.filter(line => 
                line.fullText.replace(/\s/g, '').includes(cedula)
            );
        }
        
        if (foundLines.length > 0) {
            if (isInstructorSign) {
                locationsToSign = foundLines.map(line => ({
                    nombre: INSTRUCTOR_SIGNATURE_TEXT,
                    x: line.x + INSTRUCTOR_SIGNATURE_X_OFFSET,
                    y: line.y + INSTRUCTOR_SIGNATURE_Y_OFFSET,
                    width: INSTRUCTOR_SIGNATURE_WIDTH,
                    height: INSTRUCTOR_SIGNATURE_HEIGHT,
                    pageIndex: line.pageIndex
                }));
            } else {
                locationsToSign = foundLines.map(line => ({
                    nombre: line.fullText,
                    x: PARTICIPANT_SIGNATURE_COLUMN_X,
                    y: line.y + PARTICIPANT_SIGNATURE_Y_OFFSET,
                    width: PARTICIPANT_SIGNATURE_WIDTH,
                    height: PARTICIPANT_SIGNATURE_HEIGHT,
                    pageIndex: line.pageIndex
                }));
            }

            signatureUserName.textContent = `Confirma tu firma (${locationsToSign.length} lugares encontrados)`;
            signatureModal.style.display = 'flex';
            
            setTimeout(() => {
                resizeCanvas();
            }, 10);
            
        } else {
            updateStatus(`No se encontró la cédula o el texto "${userInput}" en el documento. Por favor, verifique.`, 'error');
        }
    });

    clearSignatureBtn.addEventListener('click', () => signaturePad.clear());

    saveSignatureBtn.addEventListener('click', async () => {
        if (signaturePad.isEmpty()) {
            alert("Por favor, dibuje su firma.");
            return;
        }
        const signatureImage = signaturePad.toDataURL('image/png');
        signatureModal.style.display = 'none';
        updateStatus(`Incrustando ${locationsToSign.length} firma(s) en el documento...`, 'info');
        
        await embedSignatures(signatureImage, locationsToSign);
    });

    async function embedSignatures(signatureImage, signatureInfos) {
        try {
            pdfDoc = await PDFDocument.load(pdfBytes); 
            
            const pngImageBytes = await fetch(signatureImage).then(res => res.arrayBuffer());
            const pngImage = await pdfDoc.embedPng(pngImageBytes);
            
            for (const info of signatureInfos) {
                const page = pdfDoc.getPage(info.pageIndex); 

                page.drawImage(pngImage, {
                    x: info.x,
                    y: info.y,
                    width: info.width,
                    height: info.height,
                });
            }

            pdfBytes = await pdfDoc.save();
            
            await renderPdf();
            downloadBtn.disabled = false;
            // <!-- MODIFICADO: Habilitar el nuevo botón de compartir -->
            shareBtn.disabled = false;
            cedulaInput.value = '';
            const firmaText = signatureInfos.length === 1 ? 'firma' : 'firmas';
            updateStatus(`¡${signatureInfos.length} ${firmaText} añadidas con éxito! Ya puede descargar o compartir.`, 'success');

        } catch (err) {
            updateStatus(`Error al incrustar la firma: ${err.message}`, 'error');
            console.error(err);
        }
    }

    downloadBtn.addEventListener('click', () => {
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const originalFileName = fileInput.files[0].name.replace(/\.pdf$/i, '');
        link.download = `${originalFileName}-firmado.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    
    // <!-- MODIFICADO: Lógica de compartir actualizada -->
    shareBtn.addEventListener('click', async () => {
        if (!pdfBytes) {
            alert("No hay documento para compartir.");
            return;
        }
        
        const originalFileName = fileInput.files[0].name.replace(/\.pdf$/i, '');
        const fileName = `${originalFileName}-firmado.pdf`;
        
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        
        // La clave para mantener el nombre del archivo es crear un objeto File
        // El segundo argumento del constructor File() es el nombre del archivo.
        const file = new File([blob], fileName, { type: 'application/pdf' });

        // Comprobar si la API de compartir y compartir archivos es compatible
        if (navigator.share && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Documento Firmado',
                    text: `Documento: ${fileName}`,
                });
                console.log('Documento compartido exitosamente.');
            } catch (err) {
                // El error 'AbortError' ocurre si el usuario cancela el diálogo de compartir, lo ignoramos.
                if (err.name !== 'AbortError') {
                    console.error('Error al compartir el archivo:', err);
                    alert(`Error al compartir: ${err.message}`);
                }
            }
        } else {
            // Fallback para navegadores que no soportan la Web Share API (ej. Firefox, desktop)
            alert('La función de compartir no está disponible en su navegador. Por favor, descargue el archivo para compartirlo manualmente.');
        }
    });

    // --- FUNCIONES AUXILIARES ---
    async function renderPdf() {
        pdfViewer.innerHTML = '';
        const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
        
        for (let i = 0; i < pdfJsDoc.numPages; i++) {
            const page = await pdfJsDoc.getPage(i + 1);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            pdfViewer.appendChild(canvas);
        }
    }

    async function extractTextFromPdf() {
        pdfTextContent = []; 
        const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

        for (let i = 0; i < pdfJsDoc.numPages; i++) {
            const page = await pdfJsDoc.getPage(i + 1);
            const textContent = await page.getTextContent();
            
            const lines = {}; 

            textContent.items.forEach(item => {
                const y = item.transform[5];
                const x = item.transform[4];
                const yKey = Math.round(y); 
                
                if (!lines[yKey]) {
                    lines[yKey] = [];
                }
                lines[yKey].push({ text: item.str, x: x });
            });
            
            for (const yKey in lines) {
                const sortedItems = lines[yKey].sort((a, b) => a.x - b.x);
                const fullText = sortedItems.map(item => item.text).join(' ');
                
                pdfTextContent.push({
                    fullText: fullText,
                    y: parseFloat(yKey),
                    x: sortedItems[0].x,
                    pageIndex: i
                });
            }
        }
    }
    
    function updateStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `status-${type} show`;
    }

    function resetUI() {
        cedulaInput.disabled = true;
        signBtn.disabled = true;
        downloadBtn.disabled = true;
        // <!-- MODIFICADO: Deshabilitar el nuevo botón de compartir en el reset -->
        shareBtn.disabled = true;
        cedulaInput.value = '';
        pdfViewer.innerHTML = '';
        statusDiv.innerHTML = '';
        statusDiv.className = '';
        locationsToSign = [];
    }
</script>

</body>
</html>
