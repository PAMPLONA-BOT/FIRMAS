<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Masiva de Registros de Formación</title>
    <!-- Librerías de PDF y Firma -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <!-- PDF.js para renderizar y extraer texto -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <style>
        body { font-family: sans-serif; background-color: #e9ecef; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #343a40; }
        .step { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #dee2e6; }
        input[type="file"], input[type="text"], button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ced4da; box-sizing: border-box; font-size: 16px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #c0c0c0; cursor: not-allowed; }
        #pdf-viewer { border: 1px solid #ccc; margin-top: 20px; max-height: 80vh; overflow-y: auto; padding: 10px; }
        #pdf-viewer h3 { background-color: #f1f1f1; padding: 8px; border-radius: 5px; margin-top: 20px; margin-bottom: 10px; text-align: center; }
        #pdf-viewer canvas { display: block; margin: 10px auto; box-shadow: 0 0 8px rgba(0,0,0,0.2); width: 100%; height: auto; }
        #status, #download-area { text-align: center; font-weight: bold; margin-top: 20px; padding: 10px; border-radius: 5px; }
        #download-area a { display: block; background-color: #28a745; color: white; padding: 12px; text-decoration: none; border-radius: 5px; margin-top: 10px; transition: background-color 0.3s; }
        #download-area a:hover { background-color: #218838; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-info { background-color: #cce5ff; color: #004085; }
        /* Modal de firma a pantalla completa */
        #signature-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.8); flex-direction: column; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; }
        #signature-pad { border: 2px dashed #007bff; border-radius: 5px; }
        .modal-content h3 { margin-top: 0; }
        .modal-controls button { width: auto; padding: 10px 20px; margin: 10px 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firma Masiva de Registros de Formación</h1>
        <p style="text-align:center;">Esta herramienta encontrará tu cédula en <b>todos los PDFs cargados y en todas sus páginas</b>, y colocará tu firma en los lugares correctos automáticamente.</p>

        <div class="step">
            <h2>Paso 1: Cargar Documento(s) PDF</h2>
            <p>Puedes seleccionar uno o varios archivos a la vez.</p>
            <input type="file" id="file-input" accept=".pdf" multiple>
        </div>

        <div class="step">
            <h2>Paso 2: Identifíquese para Firmar</h2>
            <p>Ingrese su número de cédula y presione "Buscar y Abrir Panel de Firma". La firma se aplicará en todas las coincidencias encontradas en los documentos cargados.</p>
            <input type="text" id="cedula-input" placeholder="Escriba su cédula sin puntos" disabled>
            <button id="sign-btn" disabled>Buscar y Abrir Panel de Firma</button>
        </div>

        <div class="step">
            <h2>Paso 3: Descargar Documentos Firmados</h2>
            <div id="download-area">
                <p>Aquí aparecerán los enlaces para descargar sus archivos firmados.</p>
            </div>
            <button id="whatsapp-btn" style="margin-top: 15px; background-color: #6c757d;">Información para Compartir</button>
        </div>

        <div id="status"></div>
        <div id="pdf-viewer"></div>
    </div>

    <!-- Modal para el panel de firma -->
    <div id="signature-modal">
        <div class="modal-content">
            <h3 id="signature-user-name">Dibuja tu firma en el recuadro</h3>
            <canvas id="signature-pad" width="500" height="250"></canvas>
            <div class="modal-controls">
                <button id="clear-signature">Limpiar</button>
                <button id="save-signature">Aceptar y Guardar Firma</button>
            </div>
        </div>
    </div>

<script>
    // --- ¡IMPORTANTE! CONFIGURACIÓN DE LA FIRMA ---
    const SIGNATURE_COLUMN_X = 420; // Posición HORIZONTAL (eje X) donde comenzarán TODAS las firmas.
    const SIGNATURE_Y_OFFSET = -4;  // Ajuste VERTICAL fino. Un valor negativo baja la firma, positivo la sube.
    const SIGNATURE_WIDTH = 97;     // Ancho de la imagen de la firma en el PDF.
    const SIGNATURE_HEIGHT = 20;    // Alto de la imagen de la firma en el PDF.
    // ------------------------------------------------

    // Referencias a librerías
    const { PDFDocument } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

    // Elementos del DOM
    const fileInput = document.getElementById('file-input');
    const cedulaInput = document.getElementById('cedula-input');
    const signBtn = document.getElementById('sign-btn');
    const downloadArea = document.getElementById('download-area');
    const whatsappBtn = document.getElementById('whatsapp-btn');
    const pdfViewer = document.getElementById('pdf-viewer');
    const statusDiv = document.getElementById('status');
    const signatureModal = document.getElementById('signature-modal');
    const signaturePadCanvas = document.getElementById('signature-pad');
    const signatureUserName = document.getElementById('signature-user-name');
    const saveSignatureBtn = document.getElementById('save-signature');
    const clearSignatureBtn = document.getElementById('clear-signature');

    // Variables de estado
    let loadedPdfs = []; // Array para almacenar los datos de cada PDF cargado
    let locationsToSign = []; // Array para almacenar todas las ubicaciones donde se debe firmar
    let signaturePad = new SignaturePad(signaturePadCanvas);

    // --- LÓGICA PRINCIPAL ---

    fileInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files.length === 0) return;

        resetUI();
        updateStatus(`Cargando y analizando ${files.length} archivo(s)...`, 'info');

        try {
            const processingPromises = Array.from(files).map(async (file) => {
                if (file.type !== 'application/pdf') {
                    console.warn(`Omitiendo archivo no PDF: ${file.name}`);
                    return null;
                }
                const originalBytes = new Uint8Array(await file.arrayBuffer());
                // --- CORRECCIÓN AQUÍ ---
                // Se debe pasar 'originalBytes' a la función para que sepa qué archivo analizar.
                const textContent = await extractTextFromPdf(originalBytes);
                return { file, originalBytes, textContent, signedBytes: null };
            });

            const results = await Promise.all(processingPromises);
            loadedPdfs = results.filter(p => p !== null); 

            if (loadedPdfs.length === 0) {
                 throw new Error("No se seleccionaron archivos PDF válidos.");
            }

            await renderAllPdfs();

            cedulaInput.disabled = false;
            signBtn.disabled = false;
            updateStatus(`${loadedPdfs.length} PDF(s) cargado(s) y analizado(s). Ingrese su cédula para firmar.`, 'success');

        } catch (err) {
            updateStatus(`Error al cargar los PDFs: ${err.message}`, 'error');
            console.error(err);
        }
    });

    signBtn.addEventListener('click', () => {
        const cedula = cedulaInput.value.trim().replace(/\.|,/g, '');
        if (!cedula) {
            alert('Por favor, ingrese su número de cédula.');
            return;
        }

        locationsToSign = []; 
        
        loadedPdfs.forEach((pdfData, fileIndex) => {
            const foundLines = pdfData.textContent.filter(line => 
                line.fullText.replace(/\s/g, '').includes(cedula)
            );
            
            foundLines.forEach(line => {
                locationsToSign.push({
                    fileIndex: fileIndex, 
                    pageIndex: line.pageIndex,
                    y: line.y + SIGNATURE_Y_OFFSET,
                    x: SIGNATURE_COLUMN_X
                });
            });
        });

        if (locationsToSign.length > 0) {
            signatureUserName.textContent = `Se encontraron ${locationsToSign.length} coincidencia(s). Dibuja tu firma para aplicarla en todas.`;
            signatureModal.style.display = 'flex';
            setTimeout(() => {
                const rect = signaturePadCanvas.getBoundingClientRect();
                signaturePad.canvas.width = rect.width;
                signaturePad.canvas.height = rect.height;
                signaturePad.clear();
            }, 10);
        } else {
            updateStatus(`Cédula "${cedula}" no encontrada en ninguno de los documentos. Por favor, verifique.`, 'error');
        }
    });

    clearSignatureBtn.addEventListener('click', () => signaturePad.clear());

    saveSignatureBtn.addEventListener('click', async () => {
        if (signaturePad.isEmpty()) {
            alert("Por favor, dibuje su firma.");
            return;
        }
        const signatureImage = signaturePad.toDataURL('image/png');
        signatureModal.style.display = 'none';
        updateStatus('Incrustando firmas en los documentos... Esto puede tardar un momento.', 'info');
        await embedSignatures(signatureImage);
    });

    async function embedSignatures(signatureImage) {
        try {
            const pngImageBytes = await fetch(signatureImage).then(res => res.arrayBuffer());
            
            const locationsByFile = locationsToSign.reduce((acc, loc) => {
                if (!acc[loc.fileIndex]) acc[loc.fileIndex] = [];
                acc[loc.fileIndex].push(loc);
                return acc;
            }, {});

            for (const fileIndexStr in locationsByFile) {
                const fileIndex = parseInt(fileIndexStr, 10);
                const pdfData = loadedPdfs[fileIndex];
                const locations = locationsByFile[fileIndex];

                // Usamos los bytes ya firmados si existen, si no los originales
                const bytesToLoad = pdfData.signedBytes || pdfData.originalBytes;
                const pdfDoc = await PDFDocument.load(bytesToLoad);
                const pngImage = await pdfDoc.embedPng(pngImageBytes);
                
                locations.forEach(loc => {
                    const page = pdfDoc.getPage(loc.pageIndex);
                    page.drawImage(pngImage, {
                        x: loc.x,
                        y: loc.y,
                        width: SIGNATURE_WIDTH,
                        height: SIGNATURE_HEIGHT,
                    });
                });

                pdfData.signedBytes = await pdfDoc.save();
            }

            await renderAllPdfs(true);
            displayDownloadLinks();
            cedulaInput.value = '';
            cedulaInput.focus();
            updateStatus(`¡Proceso completado! Se añadieron ${locationsToSign.length} firmas. Ya puede descargar los archivos o firmar por otra persona.`, 'success');

        } catch (err) {
            updateStatus(`Error al incrustar las firmas: ${err.message}`, 'error');
            console.error(err);
        }
    }

    function displayDownloadLinks() {
        downloadArea.innerHTML = '<h3>Archivos listos para descargar:</h3>';
        let signedCount = 0;
        loadedPdfs.forEach(pdfData => {
            if (pdfData.signedBytes) {
                const blob = new Blob([pdfData.signedBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const originalFileName = pdfData.file.name.replace(/\.pdf$/i, '');
                link.download = `${originalFileName}-firmado.pdf`;
                link.textContent = `Descargar ${link.download}`;
                downloadArea.appendChild(link);
                signedCount++;
            }
        });
        if(signedCount === 0) {
            downloadArea.innerHTML = '<p>No hay archivos firmados para descargar.</p>';
        }
    }
    
    whatsappBtn.addEventListener('click', () => {
        alert("Para compartir en WhatsApp:\n\n1. Primero, descargue los PDF firmados usando los enlaces de descarga.\n2. Luego, abra WhatsApp y adjunte los archivos que descargó.");
    });


    // --- FUNCIONES AUXILIARES ---

    async function renderAllPdfs(showSigned = false) {
        pdfViewer.innerHTML = '';
        for (const pdfData of loadedPdfs) {
            const fileTitle = document.createElement('h3');
            fileTitle.textContent = pdfData.file.name;
            pdfViewer.appendChild(fileTitle);

            const bytesToRender = (showSigned && pdfData.signedBytes) ? pdfData.signedBytes : pdfData.originalBytes;
            const pdfJsDoc = await pdfjsLib.getDocument({ data: bytesToRender }).promise;
            
            for (let i = 0; i < pdfJsDoc.numPages; i++) {
                const page = await pdfJsDoc.getPage(i + 1);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                pdfViewer.appendChild(canvas);
            }
        }
    }
    
    // La función ahora acepta los bytes del PDF como argumento
    async function extractTextFromPdf(pdfBytes) {
        const textContentArray = [];
        const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

        for (let i = 0; i < pdfJsDoc.numPages; i++) {
            const page = await pdfJsDoc.getPage(i + 1);
            const textContent = await page.getTextContent();
            
            const lines = {};
            textContent.items.forEach(item => {
                const y = item.transform[5];
                const x = item.transform[4];
                const yKey = Math.round(y); 
                
                if (!lines[yKey]) lines[yKey] = [];
                lines[yKey].push({ text: item.str, x: x });
            });
            
            for (const yKey in lines) {
                const sortedItems = lines[yKey].sort((a, b) => a.x - b.x);
                const fullText = sortedItems.map(item => item.text).join(' ');
                
                textContentArray.push({
                    fullText: fullText,
                    y: parseFloat(yKey),
                    pageIndex: i
                });
            }
        }
        return textContentArray;
    }
    
    function updateStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `status-${type}`;
    }

    function resetUI() {
        loadedPdfs = [];
        locationsToSign = [];
        cedulaInput.disabled = true;
        signBtn.disabled = true;
        cedulaInput.value = '';
        pdfViewer.innerHTML = '';
        downloadArea.innerHTML = '<p>Aquí aparecerán los enlaces para descargar sus archivos firmados.</p>';
        statusDiv.innerHTML = '';
        statusDiv.className = '';
        fileInput.value = ''; 
    }
</script>
</body>
</html>
